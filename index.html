<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Würth Compensation Engine v6.3 (Logic Optimized)</title>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --wurth-red: #CC0000;
      --wurth-dark: #111111;
      --wurth-gray: #f4f6f8;
      --wurth-border: #e2e8f0;
      --wurth-red-light: #fff1f2;
    }
    body { font-family: 'Roboto', sans-serif; background-color: var(--wurth-gray); color: #334155; }

    /* Header */
    .wurth-header { background-color: var(--wurth-dark); color: white; }
    .logo-container img { height: 40px; }

    /* Cards */
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      border: 1px solid var(--wurth-border);
      transition: transform 0.2s;
    }
    .card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025); }

    /* Drop Zones */
    .drop-zone { border: 2px dashed #cbd5e1; background: #fafafa; transition: all 0.2s; border-radius: 8px; }
    .drop-zone:hover { border-color: var(--wurth-red); background-color: #fff5f5; transform: translateY(-2px); }
    .drop-zone.uploaded { border-color: #22c55e; background-color: #f0fdf4; }

    /* Buttons */
    .btn-primary { background-color: var(--wurth-red); color: white; transition: all 0.2s; }
    .btn-primary:hover { background-color: #990000; box-shadow: 0 4px 12px rgba(204, 0, 0, 0.3); }
    .btn-secondary { background-color: white; border: 1px solid #d1d5db; color: #374151; transition: all 0.2s; }
    .btn-secondary:hover { background-color: #f3f4f6; border-color: #9ca3af; }

    /* Table (FULL WIDTH OPTIMIZATION) */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      background: white;
      position: relative;
    }

    .table-container {
      /* Removed max-height constraint slightly to allow scrolling body naturally */
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }

    .table-header {
      padding: 0.5rem 0.75rem; /* Tighter padding for density */
      text-align: left;
      font-size: 0.75rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #4b5563;
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
      position: sticky;
      top: 0;
      z-index: 30;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      transition: background-color 0.15s ease;
    }
    .table-header:hover { background: #e2e8f0; }
    .table-header[data-sortable="false"] { cursor: default; }
    .table-header .sort-ind { margin-left: 0.35rem; color: #94a3b8; font-weight: 900; }

    .table-cell {
      padding: 0.5rem 0.75rem; /* Tighter padding */
      font-size: 0.85rem;
      color: #374151;
      border-bottom: 1px solid #f1f5f9;
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
      background: white;
    }
    .table-cell:hover { background-color: #f8fafc; }

    /* Sticky Columns */
    .sticky-left-1 { position: sticky; left: 0; z-index: 15; background: white; border-right: 1px solid #e2e8f0; }
    .sticky-left-2 { position: sticky; left: 140px; z-index: 15; background: white; border-right: 1px solid #e2e8f0; } /* Adjusted based on width */
    
    /* Right Sticky Total Column */
    .sticky-right-total { 
      position: sticky; 
      right: 0; 
      z-index: 16; 
      background: #fff1f2; 
      border-left: 2px solid #fca5a5;
    } 
    .sticky-right-total.header { background: #fee2e2; z-index: 40; border-bottom: 2px solid #e2e8f0; } 
    .sticky-right-total.footer { background: #fee2e2; z-index: 40; font-weight: 900; }

    /* Footer */
    tfoot.table-footer td {
      padding: 0.75rem;
      text-align: right;
      font-size: 0.85rem;
      font-weight: 800;
      background: #f1f5f9;
      border-top: 2px solid #cbd5e1;
      position: sticky;
      bottom: 0;
      z-index: 25;
      box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.05);
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }

    /* Badges (IMPROVED) */
    .badge {
      padding: 0.25rem 0.65rem;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    /* Status Colors */
    .badge-green { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .badge-blue { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
    .badge-yellow { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
    .badge-red { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    .badge-gray { background-color: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }

    /* Animations */
    .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Modal */
    .modal-bg { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
  </style>
</head>

<body class="pb-24">

  <nav class="wurth-header sticky top-0 z-50 shadow-lg">
    <div class="w-full px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16"> <!-- Slightly smaller header -->
        <div class="flex items-center logo-container">
          <img src="https://i.ibb.co/wZyxWPDH/Wurth-Gulf-CMYK-PNG-01-white-1.png" alt="Würth Logo">
          <div class="border-l border-gray-600 pl-4 ml-4">
            <span class="block text-lg font-bold tracking-tight">COMPENSATION ENGINE</span>
            <span class="block text-[10px] text-gray-400 font-medium tracking-wide">Enterprise v6.3 (Logic Optimized)</span>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <button onclick="toggleSettings()" class="text-gray-300 hover:text-white transition-colors">
            <i class="fa-solid fa-sliders text-lg"></i>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Centered Content for Dashboard/Inputs -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">

    <div id="dashboard" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 fade-in">
      <div class="card p-4 border-l-4 border-red-600">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-[10px] font-bold text-gray-500 uppercase">Total Payout</p>
            <h3 class="text-xl font-bold text-gray-900 mt-1" id="dash-total">AED 0.00</h3>
          </div>
          <div class="p-2 bg-red-50 rounded text-red-600"><i class="fa-solid fa-coins"></i></div>
        </div>
      </div>
      <div class="card p-4 border-l-4 border-blue-600">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-[10px] font-bold text-gray-500 uppercase">Processed</p>
            <h3 class="text-xl font-bold text-gray-900 mt-1" id="dash-count">0</h3>
          </div>
          <div class="p-2 bg-blue-50 rounded text-blue-600"><i class="fa-solid fa-users"></i></div>
        </div>
      </div>
      <div class="card p-4 border-l-4 border-green-600">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-[10px] font-bold text-gray-500 uppercase">Target Met (>100%)</p>
            <h3 class="text-xl font-bold text-gray-900 mt-1" id="dash-target">0</h3>
          </div>
          <div class="p-2 bg-green-50 rounded text-green-600"><i class="fa-solid fa-check-circle"></i></div>
        </div>
      </div>
      <div class="card p-4 border-l-4 border-yellow-500">
        <div class="flex justify-between items-start">
          <div class="overflow-hidden">
            <p class="text-[10px] font-bold text-gray-500 uppercase">Top Performer</p>
            <h3 class="text-base font-bold text-gray-900 mt-1 truncate" id="dash-top">N/A</h3>
            <p class="text-xs text-green-600 font-bold" id="dash-top-val">AED 0.00</p>
          </div>
          <div class="p-2 bg-yellow-50 rounded text-yellow-600"><i class="fa-solid fa-crown"></i></div>
        </div>
      </div>
    </div>

    <div class="card mb-6">
      <div class="p-3 border-b border-gray-100 flex items-center justify-between bg-gray-50 rounded-t-lg">
        <div class="flex items-center gap-3">
          <span class="bg-gray-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold shadow">1</span>
          <h2 class="text-sm font-bold text-gray-800 uppercase tracking-wide">Data Import</h2>
        </div>
        <button onclick="resetAll()" class="text-[10px] font-bold text-gray-500 hover:text-red-600 flex items-center gap-1 transition-colors">
          <i class="fa-solid fa-rotate-right"></i> RESET
        </button>
      </div>

      <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Drop Zones -->
        <div class="drop-zone p-4 text-center cursor-pointer relative group" id="drop-hr">
          <input type="file" id="file-hr" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx,.csv" onchange="handleFile(this, 'hr')">
          <i class="fa-solid fa-users text-2xl text-gray-300 mb-2 group-hover:text-red-500 transition-colors"></i>
          <h3 class="font-bold text-gray-700 text-[10px] uppercase">Yrs of Service</h3>
          <p class="text-[10px] text-gray-400 mt-1 truncate" id="name-hr">Drag or Click</p>
        </div>
        <div class="drop-zone p-4 text-center cursor-pointer relative group" id="drop-sales">
          <input type="file" id="file-sales" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx,.csv" onchange="handleFile(this, 'sales')">
          <i class="fa-solid fa-chart-simple text-2xl text-gray-300 mb-2 group-hover:text-red-500 transition-colors"></i>
          <h3 class="font-bold text-gray-700 text-[10px] uppercase">Sales Target Fulfillment</h3>
          <p class="text-[10px] text-gray-400 mt-1 truncate" id="name-sales">Drag or Click</p>
        </div>
        <div class="drop-zone p-4 text-center cursor-pointer relative group" id="drop-comm">
          <input type="file" id="file-comm" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx,.csv" onchange="handleFile(this, 'comm')">
          <i class="fa-solid fa-money-check-dollar text-2xl text-gray-300 mb-2 group-hover:text-red-500 transition-colors"></i>
          <h3 class="font-bold text-gray-700 text-[10px] uppercase">Sales Commission</h3>
          <p class="text-[10px] text-gray-400 mt-1 truncate" id="name-comm">Drag or Click</p>
        </div>
        <div class="drop-zone p-4 text-center cursor-pointer relative group" id="drop-cust">
          <input type="file" id="file-cust" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx,.csv" onchange="handleFile(this, 'cust')">
          <i class="fa-solid fa-user-check text-2xl text-gray-300 mb-2 group-hover:text-red-500 transition-colors"></i>
          <h3 class="font-bold text-gray-700 text-[10px] uppercase">Customer Bonus</h3>
          <p class="text-[10px] text-gray-400 mt-1 truncate" id="name-cust">Drag or Click</p>
        </div>
      </div>
    </div>

    <div id="step-config" class="hidden card mb-6 fade-in">
      <div class="p-3 border-b border-gray-100 flex items-center justify-between bg-gray-50 rounded-t-lg">
        <div class="flex items-center gap-3">
          <span class="bg-gray-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold shadow">2</span>
          <h2 class="text-sm font-bold text-gray-800 uppercase tracking-wide">Configuration</h2>
        </div>
        <div class="text-[10px] text-green-600 font-medium" id="auto-map-status"></div>
      </div>

      <div class="p-4">
        <div class="mb-4 flex items-end gap-4 border-b border-gray-100 pb-4">
          <div class="w-full md:w-1/3">
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Processing Date</label>
            <input type="date" id="process-date" class="w-full border border-gray-300 rounded p-1.5 text-xs focus:border-red-500 outline-none transition-all">
          </div>
          <div class="pb-1">
            <button onclick="saveMappings()" class="text-xs text-blue-600 hover:text-blue-800 font-bold flex items-center gap-1">
              <i class="fa-solid fa-floppy-disk"></i> Save Mapping Profile
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Config Columns -->
          <div class="space-y-3">
            <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Identification</h4>
            <div class="grid grid-cols-1 gap-2">
              <label class="text-[10px] font-semibold text-gray-600">Sales Unit (ID)*</label>
              <select id="map-id" class="w-full border p-1.5 rounded text-xs bg-gray-50"></select>
              
              <label class="text-[10px] font-semibold text-gray-600">Employee Name</label>
              <select id="map-name" class="w-full border p-1.5 rounded text-xs bg-gray-50"></select>
              
              <label class="text-[10px] font-semibold text-gray-600">Joining Date</label>
              <select id="map-join-date" class="w-full border p-1.5 rounded text-xs bg-gray-50"></select>
            </div>
          </div>

          <div class="space-y-3">
            <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Sales & Comm</h4>
            <div class="grid grid-cols-1 gap-2">
              <label class="text-[10px] font-semibold text-gray-600">Monthly Sales (AED)</label>
              <select id="map-turnover" class="w-full border p-1.5 rounded text-xs bg-gray-50"></select>
              
              <label class="text-[10px] font-semibold text-gray-600">Target Fulfillment (STF%)</label>
              <select id="map-stf" class="w-full border p-1.5 rounded text-xs bg-gray-50"></select>
              
              <div class="p-2 bg-red-50 rounded border border-red-100 grid gap-2 mt-1">
                <label class="text-[10px] font-bold text-red-700">Sales Unit (ID)</label>
                <select id="map-comm-id" class="w-full border p-1 rounded text-xs bg-white"></select>
                <label class="text-[10px] font-bold text-red-700">Comm Paid Column</label>
                <select id="map-commission" class="w-full border p-1 rounded text-xs bg-white"></select>
              </div>
            </div>
          </div>

          <div class="space-y-3">
            <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Customer Metrics</h4>
            <div class="grid grid-cols-2 gap-2">
              <div><label class="text-[10px] font-semibold text-gray-600">MBC Score</label><select id="map-mbc" class="w-full border p-1.5 rounded text-xs bg-gray-50"></select></div>
              <div><label class="text-[10px] font-semibold text-gray-600">CB Result</label><select id="map-cb" class="w-full border p-1.5 rounded text-xs bg-gray-50"></select></div>
            </div>
            <div><label class="text-[10px] font-semibold text-gray-600">Division</label><select id="map-division" class="w-full border p-1.5 rounded text-xs bg-gray-50"></select></div>
            <div class="grid grid-cols-2 gap-2">
              <div><label class="text-[10px] font-bold text-red-600">New (QC)</label><select id="map-new-cust" class="w-full border border-red-100 p-1.5 rounded text-xs bg-red-50"></select></div>
              <div><label class="text-[10px] font-bold text-red-600">React (QC)</label><select id="map-react-cust" class="w-full border border-red-100 p-1.5 rounded text-xs bg-red-50"></select></div>
            </div>
          </div>
        </div>

        <div class="mt-6 flex justify-center">
          <button onclick="runCalculation()" class="btn-primary px-8 py-2.5 rounded-full shadow-lg font-bold text-sm flex items-center gap-2 transform hover:-translate-y-1 transition-all">
            <i class="fa-solid fa-calculator"></i> Calculate Payouts
          </button>
        </div>
      </div>
    </div>

  </main>

  <!-- FULL WIDTH TABLE SECTION -->
  <div id="step-preview" class="hidden w-full px-0 fade-in">
    <div class="card w-full rounded-none shadow-none border-t border-b border-gray-200">
      
      <!-- Toolbar -->
      <div class="p-3 border-b border-gray-200 bg-gray-50 flex flex-col xl:flex-row items-start xl:items-center justify-between gap-3 sticky top-16 z-40">
        <div class="flex items-center gap-3 px-4">
          <span class="bg-gray-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold shadow">3</span>
          <div>
            <h2 class="text-sm font-bold text-gray-800 uppercase tracking-wide">Review & Export</h2>
            <div class="text-[10px] font-bold text-gray-500 mt-0.5 flex gap-3">
              <span>Rows: <span id="vis-count" class="text-gray-800">0</span></span>
              <span>Total: <span id="vis-total" class="text-red-600 font-bold">0.00</span></span>
            </div>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2 px-4 w-full xl:w-auto">
          <!-- Filters -->
          <div class="relative">
            <select id="filter-division" onchange="applyFilters()" class="pl-7 pr-8 py-1.5 border rounded text-xs font-bold text-gray-600 focus:border-red-500 appearance-none bg-white w-full sm:w-auto">
              <option value="all">All Divisions</option>
            </select>
            <i class="fa-solid fa-building absolute left-2.5 top-2 text-gray-400 text-xs"></i>
          </div>

          <div class="relative">
            <select id="filter-status" onchange="applyFilters()" class="pl-7 pr-8 py-1.5 border rounded text-xs font-bold text-gray-600 focus:border-red-500 appearance-none bg-white w-full sm:w-auto">
              <option value="all">All Statuses</option>
            </select>
            <i class="fa-solid fa-tag absolute left-2.5 top-2 text-gray-400 text-xs"></i>
          </div>

          <div class="relative flex-grow sm:flex-grow-0">
            <i class="fa-solid fa-magnifying-glass absolute left-2.5 top-2 text-gray-400 text-xs"></i>
            <input type="text" id="table-search" placeholder="Search ID, Name..." class="pl-8 pr-3 py-1.5 border rounded text-xs w-full sm:w-48 focus:border-red-500 outline-none" oninput="queueFilters()">
          </div>

          <div class="w-px h-5 bg-gray-300 mx-1 hidden sm:block"></div>

          <button onclick="clearFilters()" class="btn-secondary px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1">
            <i class="fa-solid fa-eraser"></i> Clear
          </button>

          <button onclick="downloadExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition-colors">
            <i class="fa-solid fa-file-excel"></i> Export
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="table-wrapper">
        <div class="table-container" style="max-height: 65vh;">
          <table class="w-full divide-y divide-gray-200" id="preview-table">
            <thead>
              <tr>
                <th class="table-header sticky-left-1" style="min-width:140px" onclick="sortData('SalesUnit')">
                  Sales Unit <span class="sort-ind" data-key="SalesUnit"></span>
                </th>
                <th class="table-header sticky-left-2" style="min-width:200px" onclick="sortData('Name')">
                  Name <span class="sort-ind" data-key="Name"></span>
                </th>
                <th class="table-header" data-sortable="false" style="min-width:140px">
                  Status
                </th>
                <th class="table-header" onclick="sortData('JoinedDate')">
                  Joined <span class="sort-ind" data-key="JoinedDate"></span>
                </th>
                <th class="table-header" onclick="sortData('Division')">
                  Division <span class="sort-ind" data-key="Division"></span>
                </th>
                <th class="table-header text-right" onclick="sortData('TargetFulfillment')">
                  STF % <span class="sort-ind" data-key="TargetFulfillment"></span>
                </th>
                <th class="table-header text-right" onclick="sortData('MonthlySales')">
                  Sales <span class="sort-ind" data-key="MonthlySales"></span>
                </th>
                <th class="table-header text-right" onclick="sortData('SeniorityBonus')">
                  Seniority <span class="sort-ind" data-key="SeniorityBonus"></span>
                </th>
                <th class="table-header text-right" onclick="sortData('Commission')">
                  Comm <span class="sort-ind" data-key="Commission"></span>
                </th>
                <th class="table-header text-right" onclick="sortData('STFBonus')">
                  STF Bonus <span class="sort-ind" data-key="STFBonus"></span>
                </th>
                <th class="table-header text-right" onclick="sortData('CustBonus')">
                  Cust Bonus <span class="sort-ind" data-key="CustBonus"></span>
                </th>
                <th class="table-header text-right text-red-700 font-extrabold sticky-right-total header" style="min-width:120px" onclick="sortData('Total')">
                  Total <span class="sort-ind" data-key="Total"></span>
                </th>
                <th class="table-header col-notes" data-sortable="false" style="display:none">Notes</th>
              </tr>
            </thead>

            <tbody class="divide-y divide-gray-100 bg-white" id="preview-body"></tbody>

            <tfoot class="table-footer">
              <tr>
                <td colspan="5" class="text-left text-gray-500 font-normal sticky-left-1" style="text-align:left; left:0; position:sticky; background:#f1f5f9; z-index:26;">
                  <strong>TOTALS:</strong>
                </td>
                <td id="ft-stf" class="text-gray-400 font-normal">-</td>
                <td id="ft-sales">0.00</td>
                <td id="ft-sen">0.00</td>
                <td id="ft-comm">0.00</td>
                <td id="ft-stfb">0.00</td>
                <td id="ft-cust">0.00</td>
                <td id="ft-total" class="text-red-700 sticky-right-total footer">0.00</td>
                <td class="col-notes" style="display:none"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg fade-in">
    <div class="bg-white rounded-lg shadow-xl w-80 overflow-hidden">
      <div class="bg-gray-800 text-white p-3 flex justify-between items-center">
        <h3 class="font-bold text-xs uppercase">Settings</h3>
        <button onclick="toggleSettings()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="p-4 space-y-4">
        <div class="flex items-center justify-between">
          <div class="text-xs font-bold text-gray-800">Show Notes Column</div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="setting-notes" class="sr-only peer" onchange="renderTable()">
            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
          </label>
        </div>
        <div class="flex items-center justify-between">
          <div class="text-xs font-bold text-gray-800">Strict Rounding (2 decimals)</div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="setting-rounding" class="sr-only peer" checked>
            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
          </label>
        </div>
      </div>
      <div class="p-3 bg-gray-50 text-right">
        <button onclick="toggleSettings()" class="btn-primary px-3 py-1 rounded text-xs font-bold">Close</button>
      </div>
    </div>
  </div>

  <script>
    // --- State ---
    const store = {
      data: { hr: null, sales: null, comm: null, cust: null },
      headers: { hr: [], sales: [], comm: [], cust: [] },
      results: [],
      mappingsLoaded: false
    };

    document.getElementById('process-date').valueAsDate = new Date();
    loadMappings();

    // --- File Handling ---
    async function handleFile(input, type) {
      const file = input.files[0];
      if (!file) return;

      const dropZone = document.getElementById(`drop-${type}`);
      const nameLabel = document.getElementById(`name-${type}`);
      nameLabel.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-red-500"></i> Processing...';

      try {
        const buffer = await file.arrayBuffer();
        const wb = XLSX.read(buffer);
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, { defval: "" });

        if (json.length === 0) throw new Error("File is empty");

        store.data[type] = json;
        store.headers[type] = Object.keys(json[0]);

        dropZone.classList.add('uploaded');
        nameLabel.innerHTML = `<span class="text-green-700 font-bold truncate block w-full"><i class="fa-solid fa-check"></i> ${file.name}</span>`;

        checkFiles();
      } catch (err) {
        console.error(err);
        nameLabel.innerHTML = `<span class="text-red-500 font-bold">Error</span>`;
        alert("Could not read file. Please check format.");
      }
    }

    function checkFiles() {
      if (store.data.hr && store.data.sales && store.data.comm && store.data.cust) {
        initConfig();
      }
    }

    function resetAll() { location.reload(); }

    // --- Configuration ---
    function initConfig() {
      document.getElementById('step-config').classList.remove('hidden');

      const mappingConfigs = [
        { id: 'map-id', list: store.headers.hr, keys: ['sales unit', 'id', 'code'] },
        { id: 'map-name', list: store.headers.hr, keys: ['sales name', 'employee name', 'name'] },
        { id: 'map-join-date', list: store.headers.hr, keys: ['joined', 'date', 'start'] },
        { id: 'map-turnover', list: store.headers.sales, keys: ['monthly sales', 'sales', 'turnover'] },
        { id: 'map-stf', list: store.headers.sales, keys: ['fulfillment', 'target fulfillment', 'stf'] },
        { id: 'map-comm-id', list: store.headers.comm, keys: ['sales rep', 'id', 'code'] },
        { id: 'map-commission', list: store.headers.comm, keys: ['commission paid', 'incentive', 'paid'] },
        { id: 'map-mbc', list: store.headers.cust, keys: ['mbc after qc', 'mbc'] },
        { id: 'map-cb', list: store.headers.cust, keys: ['cb after qc', 'cb'] },
        { id: 'map-division', list: store.headers.cust, keys: ['division', 'sector'] },
        { id: 'map-new-cust', list: store.headers.cust, keys: ['new after qc', 'new customers'] },
        { id: 'map-react-cust', list: store.headers.cust, keys: ['react after qc', 'reactivated'] }
      ];

      mappingConfigs.forEach(cfg => populateSelect(cfg.id, cfg.list, cfg.keys));
      document.getElementById('auto-map-status').innerHTML = store.mappingsLoaded ? 'Mappings Restored' : 'Auto-Mapped';
    }

    function populateSelect(elementId, options, keywords) {
      const select = document.getElementById(elementId);
      const savedVal = localStorage.getItem('wurth_v63_' + elementId);
      select.innerHTML = '<option value="">-- Select Column --</option>';
      let selectedValue = "";

      if (savedVal && options.includes(savedVal)) {
        selectedValue = savedVal;
      } else {
        for (let kw of keywords) {
          const match = options.find(opt => opt.toLowerCase().includes(kw));
          if (match) { selectedValue = match; break; }
        }
      }

      options.forEach(opt => {
        const el = document.createElement('option');
        el.value = opt;
        el.innerText = opt;
        if (opt === selectedValue) el.selected = true;
        select.appendChild(el);
      });
    }

    function saveMappings() {
      document.querySelectorAll('select[id^="map-"]').forEach(sel => {
        if (sel.value) localStorage.setItem('wurth_v63_' + sel.id, sel.value);
      });
      alert("Mappings saved.");
    }

    function loadMappings() {
      if (localStorage.getItem('wurth_v63_map-id')) store.mappingsLoaded = true;
    }

    // --- Core Calculation Logic ---
    function runCalculation() {
      const getMap = (id) => document.getElementById(id).value;
      const map = {
        id: getMap('map-id'), name: getMap('map-name'), joinDate: getMap('map-join-date'),
        turnover: getMap('map-turnover'), stf: getMap('map-stf'),
        commId: getMap('map-comm-id'),
        commVal: getMap('map-commission'),
        mbc: getMap('map-mbc'), cb: getMap('map-cb'), division: getMap('map-division'),
        newCust: getMap('map-new-cust'), reactCust: getMap('map-react-cust')
      };

      if (!map.id || !map.joinDate) { alert("Please map Sales Unit and Joining Date."); return; }
      if (!map.commId || !map.commVal) { alert("Please map Commission ID and Commission Paid columns."); return; }

      const processDate = document.getElementById('process-date').valueAsDate;
      const round = (n) => document.getElementById('setting-rounding').checked ? Number((Math.round(n * 100) / 100).toFixed(2)) : n;
      const cleanNum = (n) => {
        if (!n) return 0;
        if (typeof n === 'number') return n;
        return parseFloat(n.toString().replace(/[^0-9.-]/g, '')) || 0;
      };

      const indexData = (dataset, idField) => {
        let idx = {};
        if (!dataset) return idx;
        dataset.forEach(row => {
          let k = String(row[idField] || "").trim();
          if (k) idx[k] = row;
        });
        return idx;
      };

      const aggregateCommission = (dataset, idField, valField) => {
        let totals = {};
        if (!dataset) return totals;
        dataset.forEach(row => {
          let k = String(row[idField] || "").trim();
          let val = cleanNum(row[valField]);
          if (k) totals[k] = (totals[k] || 0) + val;
        });
        return totals;
      };

      const idxSales = indexData(store.data.sales, map.id);
      const idxCust = indexData(store.data.cust, map.id);
      const commTotals = aggregateCommission(store.data.comm, map.commId, map.commVal);

      store.results = [];
      let stats = { total: 0, count: 0, targetMet: 0, max: 0, top: "" };
      let divisions = new Set();
      let statuses = new Set(); // For filter dropdown

      store.data.hr.forEach(row => {
        let empID = String(row[map.id] || "").trim();
        if (!empID) return;

        // Date Math
        let joinRaw = row[map.joinDate];
        let displayDate = joinRaw;
        let monthsWorked = 0;

        if (typeof joinRaw === 'number') {
          let d = new Date((joinRaw - 25569) * 86400000);
          displayDate = d.toISOString().split('T')[0];
          let diff = (processDate.getFullYear() - d.getFullYear()) * 12 + (processDate.getMonth() - d.getMonth());
          monthsWorked = diff >= 0 ? diff + 1 : 0;
        } else if (joinRaw) {
          let d = new Date(joinRaw);
          if (!isNaN(d)) {
            displayDate = d.toISOString().split('T')[0];
            let diff = (processDate.getFullYear() - d.getFullYear()) * 12 + (processDate.getMonth() - d.getMonth());
            monthsWorked = diff >= 0 ? diff + 1 : 0;
          }
        }

        // Data Retrieval
        let sRow = idxSales[empID] || {};
        let cRow = idxCust[empID] || {};

        let turnover = round(cleanNum(sRow[map.turnover]));
        let stfRaw = cleanNum(sRow[map.stf]);
        let stfScale = (stfRaw < 5 && stfRaw > 0) ? stfRaw * 100 : stfRaw;

        // Seniority
        let senBonus = 0;
        if (monthsWorked >= 144) senBonus = 4000;
        else if (monthsWorked >= 108) senBonus = 3000;
        else if (monthsWorked >= 72) senBonus = 2000;
        else if (monthsWorked >= 36) senBonus = 1000;
        else if (monthsWorked >= 13) senBonus = 500;

        // STF Bonus
        let stfBonus = 0;
        let notes = [];

        if (stfScale >= 100) {
          stats.targetMet++;
          if (stfScale >= 121 && turnover >= 131000) {
            stfBonus = turnover * 0.02;
            notes.push("STF 2% Rule");
          } else {
            let col = 0;
            if (turnover >= 131000) col = 3;
            else if (turnover >= 111000) col = 2;
            else if (turnover >= 91000) col = 1;

            if (stfScale >= 121) stfBonus = [1500, 2000, 2500, 0][col];
            else if (stfScale >= 116) stfBonus = [1250, 1750, 2250, 2400][col];
            else if (stfScale >= 110) stfBonus = [1000, 1500, 2000, 2250][col];
            else if (stfScale >= 105) stfBonus = [750, 1250, 1500, 1750][col];
            else stfBonus = [500, 1000, 1250, 1500][col];
          }
        }
        stfBonus = round(stfBonus);

        // Customer Bonus
        let custBonus = 0;
        let division = cRow[map.division] || "";
        if (division) divisions.add(division);

        const isNewHire = monthsWorked <= 7;

        if (isNewHire) {
          let nc = cleanNum(cRow[map.newCust]);
          let rc = cleanNum(cRow[map.reactCust]);
          if ((nc + rc) >= 6) {
            // Logic: New hire gets bonus if they hit 6 customers
            // We don't need STF gate for the 1500 bonus based on user code structure, 
            // but usually there is a probation check. The user code had:
            // if (monthsWorked >= 5 && <= 7 && stf < 90) -> Failed Gate
            // Otherwise -> 1500
            
            if (monthsWorked >= 5 && monthsWorked <= 7 && stfScale < 90) {
               notes.push("New Hire: Failed STF Gate");
            } else {
               custBonus = 1500;
               notes.push("New Hire: Target Met");
            }
          }
        } else {
          // Existing Staff
          if (stfScale >= 90) {
            let mbc = cleanNum(cRow[map.mbc]);
            let cb = cleanNum(cRow[map.cb]);

            let rowK = 0;
            [55, 50, 45, 40, 35, 30].some(k => { if (mbc > k) { rowK = k; return true; } });

            if (rowK > 0) {
              let cIdx = 0;
              if (cb >= 4) cIdx = 2;
              else if (cb >= 3) cIdx = 1;
              else if (cb >= 2) cIdx = 0;
              else rowK = 0;

              if (rowK > 0) {
                const m = {
                  30: [1000, 1250, 1500],
                  35: [1100, 1350, 1600],
                  40: [1200, 1500, 1700],
                  45: [1300, 1650, 2000],
                  50: [1400, 1750, 2500],
                  55: [1500, 2000, 3000]
                };
                custBonus = m[rowK][cIdx];
              }
            }
          }
        }
        custBonus = round(custBonus);

        // Commission
        let comm = round(commTotals[empID] || 0);

        let total = round(senBonus + stfBonus + custBonus + comm);

        // --- IMPROVED LOGIC: STATUS DETERMINATION ---
        let status = "";
        let badge = "badge-gray";
        let icon = "";

        if (isNewHire) {
          if (total > 0) {
            status = "New Hire: Passed";
            badge = "badge-green";
            icon = "fa-user-graduate";
          } else {
            if (turnover > 0 || stfScale > 0) {
              status = "New Hire: Pending";
              badge = "badge-blue";
              icon = "fa-hourglass-half";
            } else {
              status = "New Hire: Inactive";
              badge = "badge-gray";
              icon = "fa-user-slash";
            }
          }
        } else {
          // Existing Employee Logic
          if (turnover === 0 && stfScale === 0) {
            status = "No Activity";
            badge = "badge-gray";
            icon = "fa-minus";
          } else if (stfScale < 90 && turnover > 0) {
            status = "Target Missed"; // Missed the 90% Gate
            badge = "badge-red";
            icon = "fa-arrow-trend-down";
          } else if (total > 0) {
            status = "Bonus Paid";
            badge = "badge-green";
            icon = "fa-sack-dollar";
          } else {
            // Worked, hit >90% STF, but missed specific KPIs (MBC/CB)
            status = "No Bonus"; 
            badge = "badge-yellow";
            icon = "fa-circle-exclamation";
          }
        }

        statuses.add(status);
        stats.total += total;
        stats.count++;
        if (total > stats.max) { stats.max = total; stats.top = row[map.name] || empID; }

        store.results.push({
          SalesUnit: empID,
          Name: row[map.name] || "",
          JoinedDate: displayDate || "",
          Division: division || "",
          TargetFulfillment: stfScale || 0,
          stfDisplay: (stfScale > 0 ? stfScale.toFixed(2) + '%' : "0.00%"),
          MonthlySales: turnover || 0,
          SeniorityBonus: senBonus || 0,
          Commission: comm || 0,
          STFBonus: stfBonus || 0,
          CustBonus: custBonus || 0,
          Total: total || 0,
          Notes: notes.join(" | "),
          _status: status,
          _badge: badge,
          _icon: icon
        });
      });

      updateFilters(divisions, statuses);
      updateDashboard(stats);

      sortState.key = 'Total';
      sortState.dir = -1;
      store.results.sort((a, b) => (a.Total - b.Total) * sortState.dir);

      renderTable();
      document.getElementById('step-preview').classList.remove('hidden');
      updateSortIndicators();
    }

    // --- UI Updates ---
    function updateDashboard(s) {
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('dash-total').innerText = "AED " + fmtMoney(s.total);
      document.getElementById('dash-count').innerText = s.count;
      document.getElementById('dash-target').innerText = s.targetMet;
      document.getElementById('dash-top').innerText = s.top || "N/A";
      document.getElementById('dash-top-val').innerText = "AED " + fmtMoney(s.max);
    }

    function updateFilters(divSet, statSet) {
      const selDiv = document.getElementById('filter-division');
      selDiv.innerHTML = '<option value="all">All Divisions</option>';
      Array.from(divSet).sort().forEach(d => {
        const op = document.createElement('option');
        op.value = d; op.innerText = d;
        selDiv.appendChild(op);
      });

      const selStat = document.getElementById('filter-status');
      selStat.innerHTML = '<option value="all">All Statuses</option>';
      Array.from(statSet).sort().forEach(s => {
        const op = document.createElement('option');
        op.value = s; op.innerText = s;
        selStat.appendChild(op);
      });
    }

    function clearFilters() {
      document.getElementById('filter-division').value = 'all';
      document.getElementById('filter-status').value = 'all';
      document.getElementById('table-search').value = '';
      renderTable();
    }

    function applyFilters() { renderTable(); }

    let filterTimer = null;
    function queueFilters() {
      if (filterTimer) clearTimeout(filterTimer);
      filterTimer = setTimeout(() => renderTable(), 100);
    }

    function getVisibleResults() {
      const fDiv = document.getElementById('filter-division').value;
      const fStat = document.getElementById('filter-status').value;
      const search = document.getElementById('table-search').value.trim().toLowerCase();

      return store.results.filter(r => {
        if (fDiv !== 'all' && r.Division !== fDiv) return false;
        if (fStat !== 'all' && r._status !== fStat) return false;
        if (search) {
          const hay = `${r.SalesUnit} ${r.Name} ${r.Division}`.toLowerCase();
          if (!hay.includes(search)) return false;
        }
        return true;
      });
    }

    function renderTable() {
      const tbody = document.getElementById('preview-body');
      tbody.innerHTML = "";
      const showNotes = document.getElementById('setting-notes').checked;
      document.querySelectorAll('.col-notes').forEach(el => el.style.display = showNotes ? 'table-cell' : 'none');

      const rows = getVisibleResults();
      const frag = document.createDocumentFragment();

      let sums = { sales: 0, sen: 0, comm: 0, stfBonus: 0, cust: 0, tot: 0 };
      let stfSum = 0, stfCount = 0;

      if (rows.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="table-cell text-center text-gray-500 py-4" colspan="13">No matching records found.</td>`;
        frag.appendChild(tr);
      } else {
        rows.forEach(r => {
          sums.sales += r.MonthlySales;
          sums.sen += r.SeniorityBonus;
          sums.comm += r.Commission;
          sums.stfBonus += r.STFBonus;
          sums.cust += r.CustBonus;
          sums.tot += r.Total;

          if (typeof r.TargetFulfillment === 'number' && r.TargetFulfillment > 0) {
            stfSum += r.TargetFulfillment; stfCount += 1;
          }

          const tr = document.createElement('tr');
          tr.className = "hover:bg-gray-50 transition-colors group";
          
          tr.innerHTML = `
            <td class="table-cell font-medium sticky-left-1 text-gray-600 group-hover:text-red-700 transition-colors" style="min-width:140px">${escapeHtml(r.SalesUnit)}</td>
            <td class="table-cell font-bold text-gray-800 sticky-left-2" style="min-width:200px">${escapeHtml(r.Name)}</td>
            <td class="table-cell"><span class="badge ${r._badge}"><i class="fa-solid ${r._icon} text-[10px]"></i> ${escapeHtml(r._status)}</span></td>
            <td class="table-cell text-gray-500 text-xs">${escapeHtml(r.JoinedDate)}</td>
            <td class="table-cell text-gray-500 text-xs">${escapeHtml(r.Division)}</td>
            <td class="table-cell text-right text-xs font-mono">${escapeHtml(r.stfDisplay)}</td>
            <td class="table-cell text-right text-gray-600">${fmtMoney(r.MonthlySales)}</td>
            <td class="table-cell text-right text-gray-500">${fmtMoney(r.SeniorityBonus)}</td>
            <td class="table-cell text-right text-gray-500">${fmtMoney(r.Commission)}</td>
            <td class="table-cell text-right text-gray-500">${fmtMoney(r.STFBonus)}</td>
            <td class="table-cell text-right text-gray-500">${fmtMoney(r.CustBonus)}</td>
            <td class="table-cell text-right font-black text-red-700 sticky-right-total">${fmtMoney(r.Total)}</td>
            <td class="table-cell text-xs italic text-gray-400 col-notes" style="display:${showNotes ? 'table-cell' : 'none'}">${escapeHtml(r.Notes || "")}</td>
          `;
          frag.appendChild(tr);
        });
      }

      tbody.appendChild(frag);
      const avgStf = stfCount ? (stfSum / stfCount) : 0;
      document.getElementById('ft-stf').innerText = stfCount ? `${avgStf.toFixed(1)}%` : "-";
      document.getElementById('ft-sales').innerText = fmtMoney(sums.sales);
      document.getElementById('ft-sen').innerText = fmtMoney(sums.sen);
      document.getElementById('ft-comm').innerText = fmtMoney(sums.comm);
      document.getElementById('ft-stfb').innerText = fmtMoney(sums.stfBonus);
      document.getElementById('ft-cust').innerText = fmtMoney(sums.cust);
      document.getElementById('ft-total').innerText = fmtMoney(sums.tot);

      document.getElementById('vis-count').innerText = String(rows.length);
      document.getElementById('vis-total').innerText = fmtMoney(sums.tot);
      updateSortIndicators();
    }

    const sortState = { key: null, dir: 1 };

    function sortData(key) {
      if (sortState.key === key) sortState.dir *= -1;
      else { sortState.key = key; sortState.dir = (key === 'Total') ? -1 : 1; }

      store.results.sort((a, b) => {
        const A = a[key]; const B = b[key];
        if (typeof A === 'string' || typeof B === 'string') return String(A || "").localeCompare(String(B || "")) * sortState.dir;
        return ((A || 0) - (B || 0)) * sortState.dir;
      });
      renderTable();
    }

    function updateSortIndicators() {
      document.querySelectorAll('.sort-ind').forEach(sp => {
        sp.textContent = (sp.getAttribute('data-key') === sortState.key) ? (sortState.dir === 1 ? '▲' : '▼') : '';
      });
    }

    function fmtMoney(n) {
      const num = (typeof n === 'number' && isFinite(n)) ? n : 0;
      return new Intl.NumberFormat('en-AE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
    }

    function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }

    function escapeHtml(v) {
      return String(v ?? "").replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
    }

    function downloadExcel() {
      const showNotes = document.getElementById('setting-notes').checked;
      const rows = getVisibleResults();
      if (rows.length === 0) return alert("No data to export");

      const data = rows.map(r => {
        const row = {
          "Sales Unit": r.SalesUnit,
          "Name": r.Name,
          "Status": r._status,
          "Joined Date": r.JoinedDate,
          "Division": r.Division,
          "Target %": r.stfDisplay,
          "Monthly Sales": r.MonthlySales,
          "Seniority Bonus": r.SeniorityBonus,
          "Commission": r.Commission,
          "STF Bonus": r.STFBonus,
          "Cust Bonus": r.CustBonus,
          "Total Payout": r.Total
        };
        if (showNotes) row["Notes"] = r.Notes;
        return row;
      });

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Payout");
      XLSX.writeFile(wb, `Wurth_Payout_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
  </script>
</body>
</html>
